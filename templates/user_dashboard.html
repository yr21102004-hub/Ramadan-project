{% extends "layout.html" %}

{% block content %}
<section class="dashboard-wrapper" style="margin-top: 80px; min-height: 100vh; padding: 40px 0; background: #0a0a0a;">
    <div class="container">
        <!-- Dashboard Header / Welcome -->
        <div class="row mb-5 align-items-center" data-aos="fade-down">
            <div class="col-md-8">
                <h1 class="welcome-text text-white mb-2">Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ <span class="text-gold">{{ user.full_name }}</span>
                    ğŸ‘‹</h1>
                <p class="text-muted-dynamic">ÙŠØ³Ø¹Ø¯Ù†Ø§ Ù…ØªØ§Ø¨Ø¹Ø© ØªÙ‚Ø¯Ù… Ù…Ø´Ø±ÙˆØ¹Ùƒ ÙÙŠ <span class="text-white">{{
                        user.project_location }}</span></p>
            </div>
            <div class="col-md-4 text-md-start">
                <div class="date-badge glass">
                    <i class="fas fa-calendar-day me-2"></i> {{ user.created_at[:10] }}
                </div>
            </div>
        </div>

        <!-- Quick Stats Cards -->
        <div class="row mb-5 g-4" data-aos="fade-up">
            <div class="col-lg-3 col-md-6">
                <div class="stat-card glass h-100" onclick="switchTab('tab-progress')" style="cursor: pointer;">
                    <div class="stat-icon bg-gold-gradient">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ user.project_percentage }}%</h3>
                        <p>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card glass h-100" onclick="switchTab('tab-requests')" style="cursor: pointer;">
                    <div class="stat-icon bg-blue-gradient">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ requests|length }}</h3>
                        <p>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card glass h-100" onclick="switchTab('tab-finance')" style="cursor: pointer;">
                    <div class="stat-icon bg-green-gradient">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ payments|length }}</h3>
                        <p>Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¯ÙØ¹</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card glass h-100" onclick="switchTab('tab-ai')" style="cursor: pointer;">
                    <div class="stat-icon bg-purple-gradient">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ chats|length }}</h3>
                        <p>Ù…Ø­Ø§Ø¯Ø«Ø§Øª AI</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Main Content Area (Left side in LTR, Right in RTL) -->
            <div class="col-lg-8" data-aos="fade-left">
                <!-- Navigation Tabs -->
                <div class="glass-tabs-container mb-4">
                    <ul class="nav nav-pills custom-modern-tabs" id="dashboardTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-progress">
                                <i class="fas fa-stream me-2"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-requests">
                                <i class="fas fa-concierge-bell me-2"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-finance">
                                <i class="fas fa-wallet me-2"></i> Ø§Ù„Ù…Ø§Ø¯ÙŠØ©
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-ai">
                                <i class="fas fa-brain me-2"></i> Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø°ÙƒØ§Ø¡
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Tab Panes -->
                <div class="tab-content" id="dashboardTabsContent">
                    <!-- Progress Tab -->
                    <div class="tab-pane fade show active" id="tab-progress">
                        <div class="main-card glass p-4 mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="text-white mb-0">Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„Ù„ØªÙ†ÙÙŠØ°</h4>
                                <span class="badge bg-gold text-dark px-3 py-2">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²: {{
                                    user.project_percentage }}%</span>
                            </div>

                            <div class="modern-progress-wrapper mb-5">
                                <div class="progress"
                                    style="height: 12px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                    <div class="progress-bar progress-bar-animated bg-gold-gradient"
                                        style="width: {{ user.project_percentage or 0 }}%;"></div>
                                </div>
                            </div>

                            <div class="timeline-steps row text-center">
                                <div class="col-4 step-item {% if user.project_percentage >= 20 %}completed{% endif %}">
                                    <div class="step-icon"><i class="fas fa-clipboard-check"></i></div>
                                    <p>Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØ§Ù„Ø±ÙØ¹</p>
                                </div>
                                <div class="col-4 step-item {% if user.project_percentage >= 60 %}active{% endif %}">
                                    <div class="step-icon"><i class="fas fa-tools"></i></div>
                                    <p>Ø§Ù„ØªØ£Ø³ÙŠØ³ ÙˆØ§Ù„Ø¯Ù‡Ø§Ù†</p>
                                </div>
                                <div
                                    class="col-4 step-item {% if user.project_percentage == 100 %}completed{% endif %}">
                                    <div class="step-icon"><i class="fas fa-flag-checkered"></i></div>
                                    <p>Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</p>
                                </div>
                            </div>
                        </div>

                        <div class="main-card glass p-4">
                            <h5 class="text-gold mb-3"><i class="fas fa-info-circle me-2"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª</h5>
                            <div class="specs-grid">
                                <div class="spec-inline">
                                    <span class="label">Ø§Ù„Ù…ÙˆÙ‚Ø¹:</span>
                                    <span class="value">{{ user.project_location }}</span>
                                </div>
                                <div class="spec-block mt-3">
                                    <span class="label d-block mb-2">ÙˆØµÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø§ØµØ©:</span>
                                    <div class="description-box">{{ user.project_description }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Requests Tab -->
                    <div class="tab-pane fade" id="tab-requests">
                        <div class="main-card glass p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="text-white mb-0">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h4>
                                <a href="{{ url_for('web.contact') }}" class="btn btn-gold btn-sm"><i
                                        class="fas fa-plus me-1"></i> Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</a>
                            </div>
                            {% if requests %}
                            <div class="requests-list">
                                {% for req in requests %}
                                <div class="request-item-card glass mb-3">
                                    <div class="d-flex justify-content-between align-items-center p-3">
                                        <div class="d-flex align-items-center">
                                            <div class="req-icon me-3"><i class="fas fa-paper-plane"></i></div>
                                            <div>
                                                <h6 class="text-white mb-1">{{ req.service or 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ø¹Ø§Ù…Ø©' }}</h6>
                                                <small class="text-muted">{{ req.created_at }}</small>
                                            </div>
                                        </div>
                                        <span class="status-badge pending">ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
                                    </div>
                                    <div class="p-3 pt-0 border-top border-dim">
                                        <p class="mb-0 small text-muted-dynamic">{{ req.message }}</p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="empty-placeholder py-5">
                                <i class="fas fa-folder-open mb-3 opacity-25" style="font-size: 3rem;"></i>
                                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Finance Tab -->
                    <div class="tab-pane fade" id="tab-finance">
                        <div class="main-card glass p-4 mb-4">
                            <h5 class="text-gold mb-3">Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª</h5>
                            {% if subscriptions %}
                            {% for sub in subscriptions %}
                            <div class="sub-row d-flex justify-content-between align-items-center mb-2 p-2 rounded"
                                style="background: rgba(255,255,255,0.02);">
                                <span>{{ sub.plan_name }}</span>
                                <span class="text-success small">ØµØ§Ù„Ø­ Ø­ØªÙ‰: {{ sub.expiry_date }}</span>
                            </div>
                            {% endfor %}
                            {% else %}
                            <p class="text-muted small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø§Ù‚Ø§Øª Ù…ÙØ¹Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                            {% endif %}
                        </div>

                        <div class="main-card glass p-4">
                            <h5 class="text-white mb-4">Ø³Ø¬Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h5>
                            {% if payments %}
                            <div class="table-responsive">
                                <table class="table modern-table">
                                    <thead>
                                        <tr>
                                            <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                                            <th>Ø§Ù„ÙˆØ³ÙŠÙ„Ø©</th>
                                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for p in payments %}
                                        <tr>
                                            <td class="text-gold fw-bold">{{ p.amount }} Ø¬.Ù…</td>
                                            <td>{{ p.method }}</td>
                                            <td class="small">{{ p.timestamp[:10] }}</td>
                                            <td><i class="fas fa-check-circle text-success me-1"></i> Ù…Ø±Ø§Ø¬Ø¹Ø©</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <p class="text-center text-muted py-4">Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø¯ÙØ¹</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- AI Tab -->
                    <div class="tab-pane fade" id="tab-ai">
                        <div class="main-card glass p-4">
                            <h5 class="text-blue mb-4"><i class="fas fa-robot me-2"></i> Ø°ÙƒØ§Ø¡ RMG - Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h5>

                            {% if unanswered %}
                            <div class="alert-box mb-4">
                                <h6 class="small fw-bold mb-2"><i class="fas fa-clock me-1"></i> Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:
                                </h6>
                                {% for u in unanswered %}
                                <div class="pending-question mb-2 p-2 rounded" style="background: rgba(0,0,0,0.2);">
                                    <span class="small">"{{ u.question }}"</span>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}

                            <div class="chat-archive">
                                {% if chats %}
                                {% for chat in chats[:10] %}
                                <div class="chat-thread mb-3">
                                    <div class="user-bubble">{{ chat.message }}</div>
                                    <div class="bot-bubble">{{ chat.response }}</div>
                                </div>
                                {% endfor %}
                                {% else %}
                                <p class="text-center text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø±Ø´ÙŠÙ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar: User Details (Right side in LTR, Left in RTL) -->
            <div class="col-lg-4" data-aos="fade-right">
                <div class="sidebar-card glass p-4 text-center mb-4 sticky-top" style="top: 100px;">
                    <div class="profile-avatar-container mb-3">
                        {% if user.profile_image %}
                        <img src="{{ url_for('static', filename=user.profile_image) }}" alt="User Image">
                        {% else %}
                        <img src="{{ url_for('static', filename='default_avatar.png') }}" alt="Default">
                        {% endif %}
                    </div>
                    <h4 class="text-white mb-1">{{ user.full_name }}</h4>
                    <span class="role-badge mb-4">Ø¹Ù…ÙŠÙ„ Ù…Ø®ØµØµ</span>

                    <div class="sidebar-info-rows text-md-start mt-4">
                        <div class="info-row-item">
                            <span class="label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</span>
                            <span class="value">{{ user.username }}</span>
                        </div>
                        <div class="info-row-item">
                            <span class="label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</span>
                            <span class="value" style="direction: ltr;">{{ user.phone }}</span>
                        </div>
                        <div class="info-row-item">
                            <span class="label">Ø§Ù„Ø¨Ø±ÙŠØ¯:</span>
                            <span class="value">{{ user.email or 'N/A' }}</span>
                        </div>
                    </div>

                    <div class="divider my-4"></div>

                    <div class="sidebar-actions d-grid gap-2">
                        {% if current_user.role == 'admin' %}
                        <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-outline-gold mb-2">
                            <i class="fas fa-shield-alt me-1"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                        </a>
                        {% endif %}
                        <a href="{{ url_for('admin.setup_2fa') }}" class="btn btn-outline-gold mb-2">
                            <i class="fas fa-lock me-1"></i> ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø­Ø³Ø§Ø¨ (2FA)
                        </a>
                        <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger">
                            <i class="fas fa-sign-out-alt me-1"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    /* Global Layout Fixes */
    .dashboard-wrapper {
        text-align: right;
        direction: rtl;
    }

    /* Stat Cards */
    .stat-card {
        padding: 25px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: 0.3s;
        border: 1px solid rgba(255, 255, 255, 0.03);
    }

    .stat-card:hover {
        transform: translateY(-5px);
        border-color: rgba(212, 175, 55, 0.3);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: #000;
    }

    .bg-gold-gradient {
        background: linear-gradient(135deg, #FFD700, #D4AF37);
        color: #000 !important;
    }

    .bg-blue-gradient {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: #fff !important;
    }

    .bg-green-gradient {
        background: linear-gradient(135deg, #28a745, #1e7e34);
        color: #fff !important;
    }

    .bg-purple-gradient {
        background: linear-gradient(135deg, #6f42c1, #563d7c);
        color: #fff !important;
    }

    .stat-info h3 {
        margin: 0;
        color: #fff;
        font-size: 1.5rem;
        font-weight: 800;
    }

    .stat-info p {
        margin: 0;
        color: #888;
        font-size: 0.85rem;
    }

    /* Tabs Navigation */
    .glass-tabs-container {
        background: rgba(255, 255, 255, 0.02);
        border-radius: 15px;
        padding: 8px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .custom-modern-tabs {
        border: none;
        gap: 10px;
    }

    .custom-modern-tabs .nav-link {
        color: #888;
        background: transparent;
        border-radius: 12px;
        padding: 10px 20px;
        font-weight: 500;
        transition: 0.3s;
        border: 1px solid transparent;
    }

    .custom-modern-tabs .nav-link.active {
        background: rgba(212, 175, 55, 0.1) !important;
        color: var(--gold) !important;
        border-color: rgba(212, 175, 55, 0.2) !important;
    }

    /* Main Content Cards */
    .main-card {
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Timeline Steps */
    .step-item {
        position: relative;
    }

    .step-icon {
        width: 45px;
        height: 45px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 50%;
        margin: 0 auto 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #555;
        transition: 0.3s;
    }

    .step-item.completed .step-icon {
        background: #4CAF50;
        color: #fff;
    }

    .step-item.active .step-icon {
        background: var(--gold);
        color: #000;
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
    }

    .step-item p {
        font-size: 0.8rem;
        color: #777;
    }

    /* Requests Layout */
    .request-item-card {
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .req-icon {
        color: var(--gold);
        background: rgba(212, 175, 55, 0.1);
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
    }

    .status-badge {
        font-size: 0.7rem;
        padding: 4px 10px;
        border-radius: 20px;
    }

    .status-badge.pending {
        background: rgba(33, 150, 243, 0.15);
        color: #2196f3;
    }

    /* Chat Bubbles */
    .chat-thread {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .user-bubble {
        align-self: flex-start;
        background: rgba(255, 255, 255, 0.05);
        padding: 10px 15px;
        border-radius: 15px 15px 15px 0;
        font-size: 0.9rem;
        color: #fff;
    }

    .bot-bubble {
        align-self: flex-end;
        background: rgba(33, 150, 243, 0.1);
        padding: 10px 15px;
        border-radius: 15px 15px 0 15px;
        font-size: 0.9rem;
        color: #ddd;
        border: 1px solid rgba(33, 150, 243, 0.1);
    }

    /* Sidebar Avatar */
    .profile-avatar-container {
        width: 120px;
        height: 120px;
        margin: 0 auto;
        border-radius: 50%;
        border: 3px solid var(--gold);
        overflow: hidden;
    }

    .profile-avatar-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .role-badge {
        background: rgba(212, 175, 55, 0.1);
        color: var(--gold);
        font-size: 0.75rem;
        padding: 5px 15px;
        border-radius: 20px;
        border: 1px solid rgba(212, 175, 55, 0.2);
    }

    .info-row-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-size: 0.9rem;
    }

    .info-row-item .label {
        color: #888;
    }

    .info-row-item .value {
        color: #fff;
        font-weight: 600;
    }

    .description-box {
        background: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 10px;
        color: #aaa;
        line-height: 1.6;
        font-size: 0.9rem;
        border-right: 3px solid var(--gold);
    }

    /* Buttons */
    .btn-gold {
        background: var(--gold);
        color: #000;
        font-weight: 700;
        border-radius: 10px;
    }

    .btn-outline-gold {
        border: 1px solid var(--gold);
        color: var(--gold);
        transition: 0.3s;
    }

    .btn-outline-gold:hover {
        background: var(--gold);
        color: #000;
    }

    @media (max-width: 991px) {
        .dashboard-wrapper {
            padding: 20px 10px;
        }

        .sidebar-card {
            position: static !important;
            margin-bottom: 30px;
        }

        .col-md-4 {
            text-align: center !important;
            margin-top: 15px;
        }
    }
</style>

<script>
    function switchTab(tabId) {
        // Find the button that controls this tab
        const tabTriggerEl = document.querySelector(`button[data-bs-target="#${tabId}"]`);
        if (tabTriggerEl) {
            // Use Bootstrap Tab API to show the tab
            const tab = new bootstrap.Tab(tabTriggerEl);
            tab.show();

            // Optional: Smooth scroll to the tabs section if on mobile
            if (window.innerWidth < 992) {
                document.querySelector('.glass-tabs-container').scrollIntoView({ behavior: 'smooth' });
            }
        }
    }
</script>
{% endblock %}