{% extends "layout.html" %}

{% block content %}
<section class="section-padding admin-section-bg">
    <div class="container">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-5" data-aos="fade-down">
            <div>
                <h2 class="section-title mb-0">لوحة التحكم الرئيسية</h2>
                <p class="text-muted mt-2">مرحباً بك، {{ current_user.full_name }}</p>
            </div>
            <div>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
                    <i class="fas fa-sign-out-alt me-2"></i> تسجيل الخروج
                </a>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="row mb-5 g-4" data-aos="fade-up">
            <div class="col-lg-3 col-md-6">
                <div class="stat-card glass h-100">
                    <div class="stat-icon bg-primary-gradient">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ analytics.total_users }}</h3>
                        <p>إجمالي المستخدمين</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card glass h-100">
                    <div class="stat-icon bg-warning-gradient">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ analytics.total_requests }}</h3>
                        <p>طلبات المعاينة</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card glass h-100">
                    <div class="stat-icon bg-success-gradient">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ analytics.conversion_rate }}%</h3>
                        <p>نسبة التحويل</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card glass h-100">
                    <div class="stat-icon bg-danger-gradient">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ unanswered|length }}</h3>
                        <p>أسئلة بانتظار الرد</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Navigation Cards -->
        <div class="row g-4 mb-5" data-aos="fade-up">
            <!-- Users Card -->
            <div class="col-lg-4 col-md-6">
                <a href="{{ url_for('admin.admin_users') }}" class="nav-card glass">
                    <div class="nav-card-icon bg-blue-gradient">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <h4>إدارة المستخدمين</h4>
                    <p>عرض وإدارة حسابات العملاء</p>
                    <div class="nav-card-badge">{{ users|selectattr('role', 'equalto', 'user')|list|length }} عميل</div>
                </a>
            </div>

            <!-- Workers Card -->
            <div class="col-lg-4 col-md-6">
                <a href="{{ url_for('admin.admin_workers') }}" class="nav-card glass">
                    <div class="nav-card-icon bg-orange-gradient">
                        <i class="fas fa-hard-hat"></i>
                    </div>
                    <h4>إدارة الصنايعية</h4>
                    <p>عرض وإدارة حسابات العمال</p>
                    <div class="nav-card-badge">{{ users|selectattr('role', 'equalto', 'worker')|list|length }} عامل
                    </div>
                </a>
            </div>

            <!-- Analytics Card -->
            <div class="col-lg-4 col-md-6">
                <a href="{{ url_for('admin.analytics_dashboard') }}" class="nav-card glass">
                    <div class="nav-card-icon bg-purple-gradient">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h4>الإحصائيات المتقدمة</h4>
                    <p>تحليلات شاملة للموقع</p>
                    <div class="nav-card-badge"><i class="fas fa-chart-bar"></i></div>
                </a>
            </div>

            <!-- Messages Card -->
            <div class="col-lg-4 col-md-6">
                <a href="#messagesSection" class="nav-card glass">
                    <div class="nav-card-icon bg-green-gradient">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <h4>الرسائل</h4>
                    <p>رسائل التواصل من العملاء</p>
                    <div class="nav-card-badge">{{ messages|length }} رسالة</div>
                </a>
            </div>

            <!-- AI Chats Card -->
            <div class="col-lg-4 col-md-6">
                <a href="{{ url_for('admin.view_chats') }}" class="nav-card glass">
                    <div class="nav-card-icon bg-cyan-gradient">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h4>محادثات الذكاء الاصطناعي</h4>
                    <p>عرض جميع المحادثات</p>
                    <div class="nav-card-badge">{{ chats|length }} محادثة</div>
                </a>
            </div>

            <!-- Security Card -->
            <div class="col-lg-4 col-md-6">
                <a href="{{ url_for('admin.security_audit') }}" class="nav-card glass">
                    <div class="nav-card-icon bg-red-gradient">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h4>الأمان والمراقبة</h4>
                    <p>سجلات الأمان والفحص</p>
                    <div class="nav-card-badge"><i class="fas fa-lock"></i></div>
                </a>
            </div>

            <!-- Inspections Card -->
            <div class="col-lg-4 col-md-6">
                <a href="{{ url_for('admin.admin_inspections') }}" class="nav-card glass">
                    <div class="nav-card-icon bg-purple-gradient">
                        <i class="fas fa-search-location"></i>
                    </div>
                    <h4>إدارة المعاينات</h4>
                    <p>توزيع ومتابعة الطلبات</p>
                    <div class="nav-card-badge">جديد</div>
                </a>
            </div>

            <!-- Verification Card -->
            <div class="col-lg-4 col-md-6">
                <a href="{{ url_for('admin.admin_verifications') }}" class="nav-card glass">
                    <div class="nav-card-icon bg-success-gradient">
                        <i class="fas fa-id-card-alt"></i>
                    </div>
                    <h4>طلبات التوثيق</h4>
                    <p>مراجعة هويات الصنايعية</p>
                    <div class="nav-card-badge text-gold"><i class="fas fa-check-circle"></i></div>
                </a>
            </div>
            <i class="fas fa-search-location"></i>
        </div>
        <h4>إدارة المعاينات</h4>
        <p>توزيع ومتابعة الطلبات</p>
        <div class="nav-card-badge">جديد</div>
        </a>
    </div>

    <!-- Complaints Card -->
    <div class="col-lg-4 col-md-6">
        <a href="{{ url_for('admin.admin_complaints') }}" class="nav-card glass">
            <div class="nav-card-icon bg-warning-gradient">
                <i class="fas fa-flag"></i>
            </div>
            <h4>إدارة الشكاوى</h4>
            <p>مراجعة شكاوى المستخدمين</p>
            <div class="nav-card-badge"><i class="fas fa-exclamation-triangle"></i></div>
        </a>
    </div>
    </div>

    <div class="divider my-5"></div>

    <!-- Messages Section -->
    <div id="messagesSection" class="mb-5" data-aos="fade-up">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="text-gold"><i class="fas fa-envelope me-2"></i> رسائل التواصل</h3>
        </div>

        {% if messages %}
        <div class="table-responsive">
            <table class="table modern-table">
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>الهاتف</th>
                        <th>الخدمة</th>
                        <th>الرسالة</th>
                        <th>التاريخ</th>
                        <th>إجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for msg in messages[:10] %}
                    <tr>
                        <td>{{ msg.name }}</td>
                        <td dir="ltr">{{ msg.phone }}</td>
                        <td>{{ msg.service or 'عام' }}</td>
                        <td class="text-truncate" style="max-width: 200px;">{{ msg.message }}</td>
                        <td class="small">{{ msg.created_at[:10] }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('admin.delete_message') }}" style="display: inline;">
                                <input type="hidden" name="doc_id" value="{{ msg.doc_id }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-inbox fa-3x mb-3 opacity-25"></i>
            <p>لا توجد رسائل</p>
        </div>
        {% endif %}
    </div>

    <!-- Unanswered Questions Section -->
    {% if unanswered %}
    <div class="mb-5" data-aos="fade-up">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="text-gold"><i class="fas fa-question-circle me-2"></i> أسئلة بانتظار الرد</h3>
            <span class="badge bg-danger">{{ unanswered|length }}</span>
        </div>

        {% for q in unanswered[:5] %}
        <div class="question-card glass mb-3">
            <div class="question-header">
                <strong>{{ q.user_id }}</strong>
                <span class="small text-muted">{{ q.timestamp }}</span>
            </div>
            <div class="question-body">
                <p class="mb-2"><strong>السؤال:</strong> {{ q.question }}</p>

                <!-- Show context -->
                {% set context = get_context(q.user_id, q.timestamp) %}
                {% if context %}
                <details class="mb-3">
                    <summary class="text-info small" style="cursor: pointer;">
                        <i class="fas fa-history me-1"></i> عرض السياق ({{ context|length }} رسالة)
                    </summary>
                    <div class="context-box mt-2">
                        {% for c in context %}
                        <div class="context-item">
                            <small class="text-muted">{{ c.timestamp }}</small>
                            <div class="user-msg">{{ c.message }}</div>
                            <div class="bot-msg">{{ c.response }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </details>
                {% endif %}

                <form method="POST" action="{{ url_for('admin.answer_question') }}">
                    <input type="hidden" name="question" value="{{ q.question }}">
                    <div class="mb-2">
                        <textarea name="answer" class="form-control" rows="2" placeholder="اكتب الإجابة هنا..."
                            required></textarea>
                    </div>
                    <button type="submit" class="btn btn-sm btn-gold">
                        <i class="fas fa-check me-1"></i> حفظ الإجابة
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Payments Section -->
    <div class="mb-5" data-aos="fade-up">
        <h3 class="text-gold mb-4"><i class="fas fa-money-bill-wave me-2"></i> عمليات الدفع الأخيرة</h3>

        {% if payments %}
        <div class="table-responsive">
            <table class="table modern-table">
                <thead>
                    <tr>
                        <th>المستخدم</th>
                        <th>المبلغ</th>
                        <th>الوسيلة</th>
                        <th>التاريخ</th>
                        <th>الحالة</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in payments[:10] %}
                    <tr>
                        <td>{{ p.username }}</td>
                        <td class="text-gold fw-bold">{{ p.amount }} ج.م</td>
                        <td>{{ p.method }}</td>
                        <td class="small">{{ p.timestamp[:10] }}</td>
                        <td><span class="badge bg-success">{{ p.status or 'قيد المراجعة' }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-wallet fa-3x mb-3 opacity-25"></i>
            <p>لا توجد عمليات دفع</p>
        </div>
        {% endif %}
    </div>

    </div>
</section>

<style>
    .admin-section-bg {
        background: #0a0a0a;
        min-height: 100vh;
        padding-top: 100px;
        direction: rtl;
    }

    /* Stat Cards */
    .stat-card {
        padding: 25px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: 0.3s;
        border: 1px solid rgba(255, 255, 255, 0.05);
        text-decoration: none;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        border-color: rgba(212, 175, 55, 0.3);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: #fff;
    }

    .bg-primary-gradient {
        background: linear-gradient(135deg, #007bff, #0056b3);
    }

    .bg-warning-gradient {
        background: linear-gradient(135deg, #ffc107, #ff9800);
    }

    .bg-success-gradient {
        background: linear-gradient(135deg, #28a745, #1e7e34);
    }

    .bg-danger-gradient {
        background: linear-gradient(135deg, #dc3545, #c82333);
    }

    .bg-blue-gradient {
        background: linear-gradient(135deg, #2196f3, #1976d2);
    }

    .bg-orange-gradient {
        background: linear-gradient(135deg, #ff9800, #f57c00);
    }

    .bg-purple-gradient {
        background: linear-gradient(135deg, #9c27b0, #7b1fa2);
    }

    .bg-green-gradient {
        background: linear-gradient(135deg, #4caf50, #388e3c);
    }

    .bg-cyan-gradient {
        background: linear-gradient(135deg, #00bcd4, #0097a7);
    }

    .bg-red-gradient {
        background: linear-gradient(135deg, #f44336, #d32f2f);
    }

    .stat-info h3 {
        margin: 0;
        color: #fff;
        font-size: 1.8rem;
        font-weight: 800;
    }

    .stat-info p {
        margin: 0;
        color: #888;
        font-size: 0.9rem;
    }

    /* Navigation Cards */
    .nav-card {
        display: block;
        padding: 30px;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        text-decoration: none;
        transition: 0.3s;
        position: relative;
        overflow: hidden;
    }

    .nav-card:hover {
        transform: translateY(-5px);
        border-color: rgba(212, 175, 55, 0.3);
        box-shadow: 0 10px 30px rgba(212, 175, 55, 0.2);
    }

    .nav-card-icon {
        width: 70px;
        height: 70px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #fff;
        margin-bottom: 20px;
    }

    .nav-card h4 {
        color: #fff;
        margin-bottom: 10px;
        font-size: 1.3rem;
    }

    .nav-card p {
        color: #888;
        margin-bottom: 15px;
        font-size: 0.9rem;
    }

    .nav-card-badge {
        display: inline-block;
        background: rgba(212, 175, 55, 0.1);
        color: var(--gold);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        border: 1px solid rgba(212, 175, 55, 0.2);
    }

    /* Tables */
    .modern-table {
        background: rgba(255, 255, 255, 0.02);
        border-radius: 15px;
        overflow: hidden;
    }

    .modern-table thead {
        background: rgba(212, 175, 55, 0.1);
    }

    .modern-table th {
        color: var(--gold);
        font-weight: 600;
        padding: 15px;
        border: none;
    }

    .modern-table td {
        color: #ddd;
        padding: 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .modern-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.03);
    }

    /* Question Cards */
    .question-card {
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        padding: 20px;
    }

    .question-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .question-header strong {
        color: var(--gold);
    }

    .question-body {
        color: #ddd;
    }

    .context-box {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        border-radius: 10px;
        max-height: 300px;
        overflow-y: auto;
    }

    .context-item {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .context-item:last-child {
        border-bottom: none;
    }

    .user-msg {
        background: rgba(33, 150, 243, 0.1);
        padding: 8px 12px;
        border-radius: 10px;
        margin: 5px 0;
        color: #fff;
        font-size: 0.9rem;
    }

    .bot-msg {
        background: rgba(76, 175, 80, 0.1);
        padding: 8px 12px;
        border-radius: 10px;
        margin: 5px 0;
        color: #ddd;
        font-size: 0.9rem;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }

    /* Buttons */
    .btn-gold {
        background: var(--gold);
        color: #000;
        font-weight: 700;
        border: none;
    }

    .btn-gold:hover {
        background: #FFD700;
        color: #000;
    }

    /* Glass Effect */
    .glass {
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    .divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.3), transparent);
    }
</style>
{% endblock %}